name: CI Pipeline (Dev)

on:
  push:
     branches: [dev]
  pull_request:
     branches: [dev]
      
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
       - name: Checkout Code
         uses: actions/checkout@v3

       - name: Set Up Java
         uses: actions/setup-java@v3
         with:
           distribution: 'temurin'
           java-version: '21'

       - name: Install Maven Dependencies
         run: mvn clean install

       - name: Run Unit Tests
         run: mvn test

  azureVM:
     runs-on: ubuntu-latest
     needs: [tests]
     steps:
       - name: Login to Azure
         uses: azure/login@v1
         with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

       - name: Start Azure VM
         run: |
           az vm start --resource-group demo-pipelining_group --name demo-pipelining

         
  dependency-track:
    runs-on: ubuntu-latest 
    needs: [azureVM]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Generate SBOM with CycloneDX
        run: mvn cyclonedx:makeAggregateBom

      - name: Check if SBOM Exists
        run: ls -l target/

      - name: Move SBOM to Root Directory
        run: mv target/bom.json bom.json

      - name: Upload SBOM to Dependency-Track
        uses: DependencyTrack/gh-upload-sbom@v3
        with:
          serverHostname: '40.82.200.144'
          port: ${{ secrets.DTRACK_PORT }}
          protocol: ${{ secrets.DTRACK_PROTOCOL }}
          apiKey: ${{ secrets.DTRACK_API_KEY }}
          project: ${{ secrets.PROJECT_ID }}
          projectName: 'demopipeline-backend'
          projectVersion: '1.0'
          bomFilename: "target/bom.xml"

  azurevm-stop:
      runs-on: ubuntu-latest
      needs: [dependency-track]
      steps:
        - name: Stop Azure VM
          if: always()
          run: |
           az vm deallocate --resource-group demo-pipelining_group --name demo-pipelining
